<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RemoJobs.co</title>
    <!-- Include Firebase and Auth Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="firebase.js"></script>
    <script src="auth.js"></script>
    <style>
        /* Add your styles here */

        /* Reset some default styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f7f7f7;
            line-height: 1.6;
        }

        header {
            background-color: #333;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .logo h1 {
            font-size: 2rem;
        }

        nav ul {
            list-style: none;
            text-align: center;
        }

        nav ul li {
            display: inline;
            margin: 0 1rem;
        }

        nav ul li a {
            text-decoration: none;
            color: #fff;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        nav ul li a:hover {
            color: #ddd;
        }

        /* Add your additional styles here */

        /* ... */

        /* Footer styles */
        footer {
            background-color: #333;
            color: #fff;
            text-align: center;
            padding: 1rem 0;
        }

        /* Login/Register Form styles */
        #mainContainer {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 5em auto;
            width: 90%;
        }

        .tab-button {
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .tab-button:hover {
            background-color: #555;
        }

        /* Add your additional form styles here */

        /* ... */

        /* Message Box styles */
        .mainMessage-box {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            font-weight: 800;
            width: 300px;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            transition: top 0.5s ease-in-out;
            z-index: 1000;
            text-align: center;
        }

        .mainMessage-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #mainMessageText {
            margin: 10px 0;
        }

        #mainCloseButton {
            background-color: #7b7978;
            color: #fff;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        #mainCloseButton:hover {
            background-color: #575453;
        }
    </style>
</head>
<body>
    <!-- Your HTML content goes here -->

    <header>
        <div class="logo">
            <li><a href="/RemoteJobs/"><h1>Remote Jobs</h1></a></li>
        </div>
        <nav>
            <ul>
                <li><a href="/RemoteJobs/dashboard">Dashboard</a></li>
                <li><a href="/RemoteJobs/about">About</a></li>
                <li><a href="/RemoteJobs/contact">Contact</a></li>
            </ul>
        </nav>
    </header>

    <div id="photo-area"></div>

    <div id="views">
        <div id="mainContainer">
            <!-- ... Your existing HTML content ... -->
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="">
            <p>&copy; 2024 Job Board All rights reserved. <a id="LRP" href='https://rw-501.github.io/Portfolio/'>Dev Portfolio</a></p>
        </div>
    </footer>

    <div class="mainMessage-box" id="mainMessageBox">
        <div class="mainMessage-content">
            <p id="mainMessageText">Your message here</p>
            <button id="mainCloseButton">Close</button>
        </div>
    </div>

    <!-- Your scripts go here -->
    <script>
        // Your JavaScript code goes here
    </script>
</body>
</html>



var userID;


let currentView = 0;

function nextView(userId) {
  if (currentView < 3) {
    currentView++;
    updateView(userId);
  }

}

function prevView() {
  if (currentView > 1) {
    currentView--;
    updateView();
  }
}

function skip() {
  if (currentView < 3) {
    currentView++;
    updateView();
  }
	
}
     document.getElementById('previewbtn').style.display = 'none';
     document.getElementById('progress-container').style.display = 'none';

function updateView(userId) {

	if(userId){
userID = userId;
	}
  const views = document.querySelectorAll('.view');
  views.forEach(view => view.style.display = 'none');
  document.getElementById(`view${currentView}`).style.display = 'grid';
     document.getElementById('progress-container').style.display = 'block';

  // Update progress bar
  const progressBar = document.getElementById('progress-bar');
	let percent = currentView * 100 / 3;
  progressBar.style.width  = percent+"%"

		  if (currentView === 1) {
     document.getElementById('mainContainer').style.display = 'none';
     document.getElementById('previewbtn').style.display = 'none';
     document.getElementById('nextviewbtn').style.display = 'block';

  }

	  if (currentView === 2) {
     document.getElementById('previewbtn').style.display = 'block';
     document.getElementById('nextviewbtn').style.display = 'block';

  }
	  if (currentView === 3) {
     document.getElementById('previewbtn').style.display = 'block';
     document.getElementById('nextviewbtn').style.display = 'none';

  }


const countryDropdown = document.getElementById('countryDropdown');
const stateDropdown = document.getElementById('stateDropdown');
const username = document.getElementById('username').value;
const birthday = document.getElementById('birthday').value;
const city = document.getElementById('city').value;



const selectedCountry = input(countryDropdown.value);
const selectedState = input(stateDropdown.value);
const cleanedUsername = input(username);
const cleanedBirthday = input(birthday);
const cleanedCity = input(city);


	      
if(currentView > 1 && username === ""){
showMainMessage("Username is blank");
}
	    
}


async function updateUserProfile() {
    const countryDropdown = document.getElementById('countryDropdown');
    const selectedCountry = countryDropdown.value;
    const stateDropdown = document.getElementById('stateDropdown');
    const selectedState = stateDropdown.value;
  const button = document.getElementById('doneBTN');
  button.disabled = true;
    const username = document.getElementById('username').value;
    const birthday = document.getElementById('birthday').value;
    const city = document.getElementById('city').value;

    // Use the retrieved values as needed
    console.log('Username:', username);
    console.log('birthday:', birthday);
    console.log('userId:', userID);

    if (username === "" || selectedState === "") {
        showMainMessage("Missing Info");
  button.disabled = false;
        return;
    }

    const selectedFile = document.getElementById('profilePicInput').files[0];

    if (!selectedFile) {
        try {
             firestore.collection('users').doc(userID).update({
                userName: username,
                photo: '',
                birthday: birthday,
                state: selectedState,
                city: city,
                country: selectedCountry,
                userID: userID // Changed from userID to userId
            });
            console.log(userID+'  User profile updated successfully.');
            window.location.href = `dashboard/?user=${userID}`;
        } catch (error) {
            console.error('Error updating user profile:', error);
		  button.disabled = false;

            return false;
        }
    } else {
        const storagePath = 'profilePicInput'; // Change the storage path as needed
        uploadImageToStorage(
            selectedFile,
            storagePath,
            (downloadURL) => {
                console.log(userID+'  Image uploaded successfully:', downloadURL);
                // Handle success, e.g., save the downloadURL to your database
                try {
                    firestore.collection('users').doc(userID).update({
                        userName: username,
                birthday: birthday,
                        photo: downloadURL,
                        state: selectedState,
                        city: city,
                        country: selectedCountry,
                        userID: userID // Changed from userID to userId
                    });
                   console.log('User profile updated successfully.');
                   window.location.href = `dashboard/?user=${userID}`;
                } catch (error) {
                    console.error('Error updating user profile:', error);
			  button.disabled = false;

                    return false;
                }
            });
    }
}
	    

	    
//showMainMessage("message");
// Function to open the file input dialog when the image container is clicked
function openFileInput(container) {
    container.querySelector('.file-input').click();
}

// Function to handle file upload and display the selected image
function handleFileUpload(input) {
    const file = input.files[0];

    if (file) {
        // Check file type and size here (you can use the uploadImageToStorage function from earlier)
        // For simplicity, we'll just display the selected image
        const uploadedImage = input.previousElementSibling;
        uploadedImage.src = URL.createObjectURL(file);
    }
}

	    
// Reusable function to upload an image to Firebase Storage
function uploadImageToStorage(file, storagePath, successCallback, errorCallback) {
  // Check if a file was selected
  if (!file) {
    if (errorCallback) errorCallback('Please select an image file.');
    return;
  }

  // Check file type (allow only images)
  if (!file.type.startsWith('image/')) {
    if (errorCallback) errorCallback('Please select an image file (e.g., JPEG or PNG).');
    return;
  }

  // Check file size (limit to 5MB)
  if (file.size > 5 * 1024 * 1024) {
    if (errorCallback) errorCallback('Image size must be less than 5MB.');
    return;
  }

  // Create a reference to Firebase Storage
  const storageRef = firebase.storage().ref();

  // Generate a unique filename for the image
  const timestamp = Date.now();
  const filename = `${timestamp}_${file.name}`;

  // Create a reference to the storage location
  const imageRef = storageRef.child(`${storagePath}/${filename}`);

  // Resize the image to 500x500 pixels (using a library like HTMLCanvasElement)
  const img = new Image();
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  img.onload = () => {

	  
// Max width or height for the image
const maxSize = 500;

// Calculate new dimensions while maintaining aspect ratio
let newWidth, newHeight;
if (img.width > img.height) {
  newWidth = maxSize;
  newHeight = (img.height / img.width) * maxSize;
} else {
  newHeight = maxSize;
  newWidth = (img.width / img.height) * maxSize;
}


// Resize the image using canvas
canvas.width = newWidth;
canvas.height = newHeight;
ctx.drawImage(img, 0, 0, newWidth, newHeight);


    // Convert the resized image to a Blob
    canvas.toBlob((blob) => {
      // Upload the Blob to Firebase Storage
      const uploadTask = imageRef.put(blob);

      // Monitor the upload progress
      uploadTask.on(
        'state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          console.log(`Upload progress: ${progress}%`);
        },
        (error) => {
          console.error('Upload error:', error);
          if (errorCallback) errorCallback('Image upload failed.');
        },
        () => {
          // Upload completed successfully, get the download URL
          uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
            console.log('Image URL:', downloadURL);
            if (successCallback) successCallback(downloadURL);
          });
        }
      );
    }, 'image/jpeg', 0.9); // Convert to JPEG with 90% quality
  };

  // Load the selected image
  img.src = URL.createObjectURL(file);
}




	    async function updateLoginCountAndRedirect(userDocRef, userId) {
    const userDoc = await userDocRef.get();
    if (userDoc.exists) {
        const userData = userDoc.data();

        if (userData.userName && userData.userName !== "") {
            let loginCount = userData.loginCount || 0;

            // Update the login count in Firestore
            await userDocRef.update({
                loginCount: loginCount + 1,
            });

            setTimeout(() => {
                window.location.href = `dashboard/?user=${userId}`;
            }, 3000); // 3-second timeout

        } else {
            currentView = 0;
            nextView(userId);
        }
    }
}

	    
        // JavaScript functions for login and registration
function toggleTab(tabName) {
    // Hide all forms
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('phone-form').style.display = 'none';

    // Show the selected tab
    document.getElementById(tabName + '-form').style.display = 'block';
}

        
        // JavaScript functions for login and registration

async function loginWithEmailPassword() {
    try {
        // Get input values
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        // Sign in the user
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        // Save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');

        // Get the user's ID
        const userId = userCredential.user.uid;
    console.log('userId:', userId);

        // Reference to the user document in Firestore
        const userDocRef = firestore.collection('users').doc(userId);

        // Get the current login count
        let loginCount = 0;
	    
await updateLoginCountAndRedirect(userDocRef, userId);

	

        // Update the login count in Firestore
        await userDocRef.update({
            loginCount: loginCount + 1,
        });
	    

        return true;
    } catch (error) {
        console.error('Login failed:', error.message);
	    showMainMessage("Login failed");

        return false;
    }
}


const currentDate = new Date();

// Function to log in with phone (Note: Implement Firebase phone login pop-up)
 async function loginWithPhoneAuthentication() {
    try {
        // Get the user's phone number from the input field
        const phoneNumber = document.getElementById('phone-number').value;

        // Validate the phone number (you can add more validation if needed)
        if (!phoneNumber || !/^\+\d{10,}$/g.test(phoneNumber)) {
            showMainMessage('Please enter a valid phone number in the format: +1234567890');
            return;
        }

        // Create a Recaptcha verifier for phone number verification
        const recaptcha = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            size: 'invisible',
        });

        // Send the verification code to the user's phone
        const confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, recaptcha);

        // Implement UI to allow the user to enter the code and confirm their phone number
        const verificationCode = prompt('Enter the verification code sent to your phone:');
        const userCredential = await confirmationResult.confirm(verificationCode);

        // Phone number authentication successful, you can now save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');

        // Create a user document in Firestore (if needed)
        const user = userCredential.user;
        const userId = user.uid;
        await firestore.collection('users').doc(userId).set({
            phoneNumber: user.phoneNumber,
                userName: "", 
                loginCount: 1, // Initialize login count to 1
                email: "",
            userTrees: [],
            signUpType:"Phone",
            signUpDate:  firebase.firestore.FieldValue.serverTimestamp(), // Add a timestamp,
		birthday: '',
		photo: photoURL,
		userID: userId,
		state:'',
		city:'',
		country:"USA",
            
            // Add more user-related data here
        });

        window.location.href = `dashboard/?user=${userId}`;
    } catch (error) {
        console.error('Phone login failed:', error.message);
    }
}



// Function to log in anonymously
async function loginAnonymously() {
    try {
        // Attempt to sign in anonymously
        const userCredential = await auth.signInAnonymously();
        
        // Save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');
        
        // Get the user's unique ID
        const userId = userCredential.user.uid;
        
        // Check if the user document exists in Firestore
        const userDoc = await firestore.collection('users').doc(userId).get();
        
        if (userDoc.exists) {
            // User document exists, update the login count
            await firestore.collection('users').doc(userId).update({
                loginCount: firebase.firestore.FieldValue.increment(1)
            });
        } else {
            // User document doesn't exist, create a new user document
            await firestore.collection('users').doc(userId).set({
                userName: "Anonymous", 
                loginCount: 1, // Initialize login count to 1
                email: "",
            userTrees: [],
            signUpType:"Anonymous",
            phoneNumber: "",
            signUpDate: currentDate,

                // Add more user-related data here
            });
        }
        
        // Redirect to the dashboard with user ID as a query parameter
        window.location.href = `dashboard/?user=${userId}`;
        
        return true;
    } catch (error) {
        console.error('Anonymous login failed:', error.message);
        return false;
    }
}


// Function to register a new user with email and password
async function register() {
    try {
        // Get input values
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;

        // Create a new user in Firebase Authentication
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const userId = userCredential.user.uid;
	        console.log('userId:', userId);

if(userId){
        // Save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');

        // Create a user document in Firestore with the user's UID
        await firestore.collection('users').doc(userCredential.user.uid).set({
                userName: "", 
                loginCount: 1, // Initialize login count to 1
                email: email,
            userTrees: [],
            signUpType:"Email",
            phoneNumber: "",
                 signUpDate:  firebase.firestore.FieldValue.serverTimestamp(), // Add a timestamp,
		birthday: '',
		photo: '',
		userID: userId,
		state:'',
		city:'',
		country:"USA",
			// Add more user-related data here
        });

        // Redirect to the dashboard page with user ID as a query parameter
      //  window.location.href = `dashboard/?user=${userCredential.user.uid}`;
    document.getElementById('mainContainer').style.display = 'none';

nextView(userId);
return true;

}else{
	    showMainMessage('Registration failed');

}
	    
        return true;
    } catch (error) {
	    showMainMessage(error.message);

        console.error('Registration failed:', error.message);
        return false;
    }
}

async function checkLoggedInAndRedirect() {
    const userLoggedIn = localStorage.getItem('userLoggedIn');
    const auth = firebase.auth();

    // Check if a user is currently signed in
    if (userLoggedIn === 'true' && auth.currentUser) {
        const userId = auth.currentUser.uid; // Get the user's ID
        console.log('userId:', userId);

        const userDocRef = firestore.collection('users').doc(userId);

        try {
            const userDoc = await userDocRef.get();

            if (userDoc.exists) {
                const userData = userDoc.data();

                if (userData.userName && userData.userName !== "") {
                    let loginCount = userData.loginCount || 0;

                    // Update the login count in Firestore
                    await userDocRef.update({
                        loginCount: loginCount + 1,
                    });

                    window.location.href = `dashboard/?user=${userId}`;
                } else {
                    // Handle the case where userName is empty
                    currentView = -1;
                    nextView(userId);
                }
            } else {
                console.log("User document does not exist.");
            }
        } catch (error) {
            console.error('Error getting user document:', error);
        }
    }
}

	    
	    async function loginWithGoogle() {
    try {
        // Use Firebase Google Sign-In provider
        const provider = new firebase.auth.GoogleAuthProvider();

        // Sign in with Google
        const userCredential = await firebase.auth().signInWithPopup(provider);
        // Save login status to local storage
        localStorage.setItem('userLoggedIn', 'true');

        // Get the user's ID
        const userId = userCredential.user.uid;
        const user = userCredential.user;
        const displayName = user.displayName;
        const photoURL = user.photoURL;
        const email = user.email;
        // Reference to the user document in Firestore
        const userDocRef = firestore.collection('users').doc(userId);

        // Get the current login count
        let loginCount = 0;
userID = userId;
	        console.log('userId:', userId);

  const userDoc = await userDocRef.get();
    if (userDoc.exists) {
        const userData = userDoc.data();

        if (userData.state) {
            let loginCount = userData.loginCount || 0;

            // Update the login count in Firestore
            await userDocRef.update({
                loginCount: loginCount + 1,
            });

                window.location.href = `dashboard/?user=${userId}`;

		
        } else {

		if( userData.userName !== ""){
			document.getElementById("username").value = displayName;
			const imgElement = document.getElementById("photoURL");
imgElement.src = photoURL;
            currentView = 0;
			
            nextView(userID);
		}
        }
    }else{

      // Create a user document in Firestore with the user's UID
        await firestore.collection('users').doc(userCredential.user.uid).set({
                userName: displayName, 
                loginCount: 1, // Initialize login count to 1
                email: email,
            userTrees: [],
            signUpType:"Google",
            phoneNumber: "",
            signUpDate:  firebase.firestore.FieldValue.serverTimestamp(), // Add a timestamp,
		birthday: '',
		photo: photoURL,
	userID: userId,
		state:'',
		city:'',
		country:"USA",
            // Add more user-related data here
        });
	    			document.getElementById("username").value = displayName;

			const imgElement = document.getElementById("photoURL");
imgElement.src = photoURL;
            currentView = 0;
            nextView();
    }
	

    } catch (error) {
	    	    showMainMessage("Google failed, try again");

        console.error('Login with Google failed:', error.message);
        return false;
    }
}


function setupEnterKeyNavigation(inputIdArray) {
  inputIdArray.forEach((inputId, index) => {
    const inputElement = document.getElementById(inputId);

    inputElement.addEventListener('keydown', event => {
      if (event.key === 'Enter') {
        event.preventDefault();
        //addPost();

        const nextInput = inputIdArray[index + 1];
        if (nextInput) {
          document.getElementById(nextInput).focus();
        }
      }
    });
  });
}

// Call the function and provide an array of input IDs to navigate
const inputIdsToNavigate = ['login-email', 'login-password', 'register-email', 'register-password', 'username', 'birthday', 'city', 'stateDropdown', 'countryDropdown'];
setupEnterKeyNavigation(inputIdsToNavigate);




// Call the function to check and redirect
checkLoggedInAndRedirect();

toggleTab('login');


	    
    </script>

</html>
